# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Update Lotto Data Weekly

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  # ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë²„íŠ¼ì„ ë§Œë“¦
  workflow_dispatch:
  # ìŠ¤ì¼€ì¤„ì— ë”°ë¼ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰
  schedule:
    # ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆë²½ 5ì‹œ (í•œêµ­ ì‹œê°„ ê¸°ì¤€, UTCë¡œëŠ” í† ìš”ì¼ 20ì‹œ)ì— ì‹¤í–‰
    - cron: '0 20 * * SAT'

# ì‹¤í–‰ë  ì‘ì—…(Job) ì •ì˜
jobs:
  update-data:
    # ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½ (Ubuntu ìµœì‹  ë²„ì „)
    runs-on: ubuntu-latest
    
    # ì‘ì—…ì˜ ë‹¨ê³„(Step)ë“¤
    steps:
      # 1. ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ runnerë¡œ ê°€ì ¸ì˜´ (Checkout)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. npm íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install dependencies
        run: npm install

      # 4. ë°ì´í„° ë‹¤ìš´ë¡œë“œ ë° íŒŒì¼ ì¶”ì¶œ
      - name: Run Data Scripts
        run: |
          node download.js
          node export-sql.js
          node export-json.js
      
      # 5. ì´ë©”ì¼ ë³¸ë¬¸ì„ ìœ„í•œ ì¶”ì²œ ë²ˆí˜¸ ìƒì„±
      - name: Generate recommendation numbers for email
        run: node generate-email-body.js

      # 6. ë³€ê²½ëœ ë°ì´í„° íŒŒì¼ë“¤ì„ Gitì— ë‹¤ì‹œ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and push if changed
        run: |
          # ë´‡ì˜ ì´ë¦„ê³¼ ì´ë©”ì¼ ì„¤ì •
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # ìƒì„±ëœ ëª¨ë“  ë°ì´í„° íŒŒì¼ì„ ìŠ¤í…Œì´ì§•
          git add lotto_data.html lotto_data.sql lotto_data.json
          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ê²½ìš°ì—ë§Œ ì»¤ë°‹
          git diff-index --quiet HEAD || git commit -m "ğŸ“Š Lotto data updated automatically"
          # ì €ì¥ì†Œì— í‘¸ì‹œ
          git push

      # 7. íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ì„œ ê²°ê³¼ ë³€ìˆ˜ë¡œ ì €ì¥í•˜ëŠ” ë‹¨ê³„
      - name: Read email body from file
        id: read_email_body # ì´ ë‹¨ê³„ì˜ IDë¥¼ ì§€ì •
        run: echo "EMAIL_BODY=$(cat email-body.txt)" >> $GITHUB_OUTPUT

      # 8. ì‘ì—… ì„±ê³µ ì‹œ ì´ë©”ì¼ ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: Send notification email on success
        # ì´ì „ ë‹¨ê³„ë“¤ì´ ëª¨ë‘ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP ì„œë²„ ì •ë³´ (Gmail ì˜ˆì‹œ)
          server_address: smtp.gmail.com
          server_port: 465
          # 2ë‹¨ê³„ì—ì„œ ë“±ë¡í•œ Secrets ì •ë³´ ì‚¬ìš©
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          # ë©”ì¼ ì œëª©
          subject: '[ì„±ê³µ] ë¡œë˜ ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ì´ë²ˆì£¼ ì¶”ì²œ ë²ˆí˜¸'
          # ë©”ì¼ ë³¸ë¬¸
          body: ${{ steps.read_email_body.outputs.EMAIL_BODY }}
          # ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼ ì£¼ì†Œ
          to: ${{ secrets.MAIL_USERNAME }}
          # ë³´ë‚´ëŠ” ì‚¬ëŒ ì´ë©”ì¼ ì£¼ì†Œ
          from: GitHub Actions Bot <${{ secrets.MAIL_USERNAME }}>
        